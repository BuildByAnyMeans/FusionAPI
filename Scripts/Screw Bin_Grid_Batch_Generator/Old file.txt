# Fusion 360 Script: Batch Generate Gridfinity Bins with Labels from CSV
# Version 3.0 - Works with Gridfinity Plugin's d## parameters
# 
# This script works with bins generated by the Gridfinity Fusion 360 plugin.
# It modifies the underlying model parameters (d85-d168) that the plugin creates.
#
# REQUIRED USER PARAMETERS (text) - You must create these:
# - Label_Type (text)
# - Label_Name (text)
# - Label_Color (text)
# - Label_Qt (text)
#
# INSTRUCTIONS:
# 1. Generate a Gridfinity bin using the plugin first (any size, it will be changed)
# 2. Create the 4 Label_* user parameters
# 3. Run this script
# 4. Select your Screw_Bin_Master_Sheet.csv file
# 5. Select output folder for STL files
# 6. Wait ~5-7 minutes for all bins to generate!

import adsk.core, adsk.fusion, traceback
import csv
import os

def run(context):
    ui = None
    try:
        app = adsk.core.Application.get()
        ui = app.userInterface
        design = adsk.fusion.Design.cast(app.activeProduct)
        
        if not design:
            ui.messageBox('No active Fusion design found. Please open your Gridfinity bin file first.')
            return
        
        # Get all model parameters
        model_params = design.allParameters
        
        # Get USER parameters (text labels)
        user_params = design.userParameters
        param_label_type = user_params.itemByName('Label_Type')
        param_label_name = user_params.itemByName('Label_Name')
        param_label_color = user_params.itemByName('Label_Color')
        param_label_qt = user_params.itemByName('Label_Qt')
        
        # Verify label parameters exist
        missing = []
        if not param_label_type:
            missing.append('Label_Type (user parameter, text)')
        if not param_label_name:
            missing.append('Label_Name (user parameter, text)')
        if not param_label_color:
            missing.append('Label_Color (user parameter, text)')
        if not param_label_qt:
            missing.append('Label_Qt (user parameter, text)')
        
        if missing:
            ui.messageBox('Missing required user parameters:\n\n' + '\n'.join(missing) + 
                         '\n\nPlease create these text parameters before running the script.')
            return
        
        # Verify key model parameters exist (renamed from d98/d99)
        has_bin_width = False
        has_bin_length = False
        for param in model_params:
            if param.name == 'Bin_Width':
                has_bin_width = True
            elif param.name == 'Bin_Length':
                has_bin_length = True
        
        if not has_bin_width or not has_bin_length:
            ui.messageBox('Cannot find Bin_Width and Bin_Length parameters.\n\n' +
                         'Make sure you renamed d98 to "Bin_Width" and d99 to "Bin_Length".')
            return
        
        # Prompt for CSV file
        fileDialog = ui.createFileDialog()
        fileDialog.title = 'Select Screw_Bin_Master_Sheet.csv'
        fileDialog.filter = 'CSV files (*.csv);;All files (*.*)'
        fileDialog.isMultiSelectEnabled = False
        
        if fileDialog.showOpen() != adsk.core.DialogResults.DialogOK:
            return
        
        csv_path = fileDialog.filename
        
        # Prompt for output folder
        folderDialog = ui.createFolderDialog()
        folderDialog.title = 'Select Output Folder for STL Files'
        
        if folderDialog.showDialog() != adsk.core.DialogResults.DialogOK:
            return
        
        output_folder = folderDialog.folder
        
        # Read CSV and process each bin
        with open(csv_path, 'r', encoding='utf-8') as f:
            reader = csv.DictReader(f)
            rows = list(reader)
        
        # Filter out empty rows
        rows = [row for row in rows if row['Label_Type'].strip()]
        
        total_bins = len(rows)
        progressDialog = ui.createProgressDialog()
        progressDialog.cancelButtonText = 'Cancel'
        progressDialog.isBackgroundTranslucent = False
        progressDialog.isCancelButtonShown = True
        progressDialog.show('Generating Bins', 'Processing bin %v of %m', 0, total_bins, 1)
        
        for i, row in enumerate(rows):
            if progressDialog.wasCancelled:
                break
            
            # Get values from CSV
            label_type = row['Label_Type'].strip()
            label_name = row['Label_Name'].strip()
            bin_width = int(row['Bin_Width'].strip())
            bin_length = int(row['Bin_Length'].strip())
            label_color = row['Label_Color'].strip()
            label_qt = row['Label_Qt'].strip()
            
            # Calculate all dimension values based on grid units
            # Base unit is 42mm, with 0.5mm clearance for outer dimensions
            outer_width = (bin_width * 42.0) - 0.5
            outer_length = (bin_length * 42.0) - 0.5
            inner_width = outer_width - 3.2   # Wall thickness on each side
            inner_length = outer_length - 3.2
            width_plus_1 = outer_width + 1.0  # For base features
            length_plus_1 = outer_length + 1.0
            
            # Update ALL MODEL parameters that control bin dimensions
            for param in model_params:
                param_name = param.name
                
                # Grid unit counts (user renamed these from d98/d99)
                if param_name == 'Bin_Width':
                    param.expression = str(bin_width)
                elif param_name == 'Bin_Length':
                    param.expression = str(bin_length)
                
                # Outer dimensions (multiple parameters store the same value)
                # Formula: units Ã— 42mm - 0.5mm
                elif param_name in ['d102', 'd109', 'd128', 'd143']:
                    param.expression = f'{outer_width} mm'
                elif param_name in ['d103', 'd110', 'd129', 'd144', 'd153']:
                    param.expression = f'{outer_length} mm'
                
                # Inner dimensions (outer - 3.2mm for 1.6mm walls on each side)
                elif param_name in ['d135', 'd157']:
                    param.expression = f'{inner_width} mm'
                elif param_name == 'd136':
                    param.expression = f'{inner_length} mm'
                
                # Outer + 1mm dimensions (for base/lip features)
                elif param_name == 'd118':
                    param.expression = f'{width_plus_1} mm'
                elif param_name == 'd119':
                    param.expression = f'{length_plus_1} mm'
            
            # Update USER parameters (labels) - all as TEXT with single quotes
            param_label_type.expression = f"'{label_type}'"
            param_label_name.expression = f"'{label_name}'"
            param_label_color.expression = f"'{label_color}'"
            param_label_qt.expression = f"'{label_qt}'"
            
            # Force regeneration
            adsk.doEvents()
            design.computeAll()
            
            # Create filename
            # Sanitize filename (remove special characters)
            safe_name = label_name.replace('/', '-').replace(' ', '_').replace('#', 'num')
            bin_size = f"{bin_width}x{bin_length}"
            filename = f"{label_type}_{safe_name}_{bin_size}_{label_color}.stl"
            filepath = os.path.join(output_folder, filename)
            
            # Export STL
            exportMgr = design.exportManager
            stlOptions = exportMgr.createSTLExportOptions(design.rootComponent)
            stlOptions.filename = filepath
            stlOptions.meshRefinement = adsk.fusion.MeshRefinementSettings.MeshRefinementMedium
            exportMgr.execute(stlOptions)
            
            # Update progress
            progressDialog.progressValue = i + 1
            progressDialog.message = f'Generated: {filename}'
        
        progressDialog.hide()
        
        if not progressDialog.wasCancelled:
            ui.messageBox(f'Successfully generated {total_bins} STL files in:\n{output_folder}')
        else:
            ui.messageBox('Operation cancelled by user.')
        
    except:
        if ui:
            ui.messageBox('Failed:\n{}'.format(traceback.format_exc()))